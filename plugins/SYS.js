import os from 'os';
import { exec } from 'child_process';

function formatUptime(uptime) {
  const seconds = Math.floor(uptime % 60);
  const minutes = Math.floor((uptime / 60) % 60);
  const hours = Math.floor((uptime / 3600) % 24);
  return `${hours} horas, ${minutes} minutos, ${seconds} segundos`;
}

function getVersions(callback) {
  exec('node -v', (err, nodeVersion) => {
    if (err) nodeVersion = '✖️';
    exec('npm -v', (err, npmVersion) => {
      if (err) npmVersion = '✖️';
      exec('ffmpeg -version', (err, ffmpegVersion) => {
        if (err) ffmpegVersion = '✖️';
        exec('python --version', (err, pythonVersion) => {
          if (err) pythonVersion = '✖️';
          exec('pip --version', (err, pipVersion) => {
            if (err) pipVersion = '✖️';
            exec('choco -v', (err, chocoVersion) => {
              if (err) chocoVersion = '✖️';
              callback({ nodeVersion, npmVersion, ffmpegVersion, pythonVersion, pipVersion, chocoVersion });
            });
          });
        });
      });
    });
  });
}

async function systemInfoPlugin(m, extra) {
  try {
    const systemInfo = {
      platform: os.platform(),
      cpuArch: os.arch(),
      cpus: os.cpus().length,
      totalMemory: (os.totalmem() / (1024 ** 3)).toFixed(2) + ' GB', 
      freeMemory: (os.freemem() / (1024 ** 3)).toFixed(2) + ' GB',   
      uptime: formatUptime(os.uptime()),                             
      osVersion: os.release(),                                       
      loadAverage: os.loadavg().map(load => load.toFixed(2)).join(', '), 
    };

    getVersions((versions) => {
      let infoMessage = `*Información del Sistema*\n\n`;
      infoMessage += `- Plataforma: ${systemInfo.platform}\n`;
      infoMessage += `- Arquitectura CPU: ${systemInfo.cpuArch}\n`;
      infoMessage += `- Núcleos CPU: ${systemInfo.cpus}\n`;
      infoMessage += `- Memoria Total: ${systemInfo.totalMemory}\n`;
      infoMessage += `- Memoria Libre: ${systemInfo.freeMemory}\n`;
      infoMessage += `- Tiempo de Actividad: ${systemInfo.uptime}\n`;
      infoMessage += `- Versión del SO: ${systemInfo.osVersion}\n`;
      infoMessage += `- Carga Promedio (1, 5, 15 min): ${systemInfo.loadAverage}\n\n`;

      infoMessage += `*Version de Herramientas*\n\n`;
      infoMessage += `- Node.js: ${versions.nodeVersion.trim()}\n`;
      infoMessage += `- npm: ${versions.npmVersion.trim()}\n`;
      infoMessage += `- ffmpeg: ${versions.ffmpegVersion.split('\n')[0]}\n`; // Solo primera linea
      infoMessage += `- Python: ${versions.pythonVersion.trim()}\n`;
      infoMessage += `- pip: ${versions.pipVersion.trim()}\n`;
      infoMessage += `- Chocolatey: ${versions.chocoVersion.trim()}\n`;

      extra.conn.sendMessage(m.chat, { text: infoMessage });
    });
  } catch (error) {
    console.error('Falla Plugin sysinfo:', error);
    await extra.conn.sendMessage(m.chat, { text: 'ERROR' });
  }
}

systemInfoPlugin.command = ['sysinfo']; 

export default systemInfoPlugin;
